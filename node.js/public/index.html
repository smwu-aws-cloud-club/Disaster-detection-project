<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FCM 토큰 테스트</title>
  </head>
  <body>
    <h1>FCM 웹 테스트</h1>
    <button id="getTokenBtn">FCM 토큰 발급</button>
    <div id="tokenDisplay">FCM 토큰:</div>

    <!-- Firebase SDK -->
    <script type="module">
      import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getMessaging,
        getToken,
        onMessage,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging.js";

      // Firebase 설정
      const firebaseConfig = {
        apiKey: "AIzaSyCnIqHUpsH9MN6cBvrXmUz37cInpSc6mKU",
        authDomain: "disaster-detection-project.firebaseapp.com",
        projectId: "disaster-detection-project",
        storageBucket: "disaster-detection-project.firebasestorage.app",
        messagingSenderId: "444335381733",
        appId: "1:444335381733:web:1e7054695e62b0a541080c",
        measurementId: "G-DTCW9W6F4R",
      };

      // Firebase 앱 초기화
      const app = initializeApp(firebaseConfig);
      const messaging = getMessaging(app);

      // 클라이언트에서 현재 토큰을 로컬 스토리지에 저장
      let storedFCMToken = localStorage.getItem("fcmToken");

      async function sendTokenToServer(token) {
        console.log("서버로 토큰 전송 시도:", token);
        try {
          const response = await fetch("http://localhost:3000/topic-all", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({token: token, topic: "all"}),
          });

          if (response.ok) {
            console.log("all 토픽에 성공적으로 구독되었습니다!");
            alert("all 토픽에 성공적으로 구독되었습니다!");
            // 토큰을 서버에 성공적으로 보냈으므로 로컬 스토리지에 저장
            localStorage.setItem("fcmToken", token);
            storedFCMToken = token; // 변수도 업데이트
          } else {
            const errorData = await response.json();
            console.error("토픽 구독 실패:", errorData);
            alert("토픽 구독에 실패했습니다.");
          }
        } catch (error) {
          console.error("서버 통신 오류:", error);
        }
      }

      async function requestAndHandleFCMToken() {
        try {
          // 1. 알림 권한 요청
          const permission = await Notification.requestPermission();
          if (permission !== "granted") {
            console.warn("알림 권한이 부여되지 않았습니다.");
            alert("알림 권한을 허용해야 푸시 알림을 받을 수 있습니다.");
            return;
          }

          // 2. FCM 토큰 가져오기
          const currentToken = await getToken(messaging, {
            vapidKey: "BEA9zr0xPeBmZhSkOlsKQS-douJRScq4GjJLPoO2l6X4LmTnPnHhB146XI0GdWfxHKvwmRtyEoXLwKaNq-hxC3M",
          });

          if (currentToken) {
            console.log("현재 FCM 토큰:", currentToken);
            document.getElementById("tokenDisplay").innerText = `FCM 토큰: ${currentToken}`;

            // 3. 토큰이 변경되었거나, 처음 발급받은 경우에만 서버로 전송
            if (currentToken !== storedFCMToken) {
              console.log("FCM 토큰이 변경/새로 발급됨. 서버로 전송");
              await sendTokenToServer(currentToken);
            } else {
              console.log("FCM 토큰이 이전과 동일.");
            }
          } else {
            console.warn("FCM 토큰 존재 X. 권한이 거부되었거나 VAPID 키 확인 필요");
            alert("FCM 토큰을 가져올 수 없습니다. 알림 권한을 확인해주세요.");
          }
        } catch (err) {
          console.error("FCM 토큰 발급/처리 오류:", err);
          alert("FCM 토큰을 처리하는 중 오류가 발생했습니다.");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        console.log("페이지 로드 완료, FCM 토큰 처리 시작...");
        requestAndHandleFCMToken();
      });

      document.getElementById("getTokenBtn").addEventListener("click", requestAndHandleFCMToken);

      // 푸시 메시지 수신 처리
      onMessage(messaging, (payload) => {
        console.log("수신된 메시지 (포그라운드):", payload);
        // 푸시 메시지가 수신되면 브라우저에서 알림 표시
        const {title, body} = payload.notification || {};
        const icon = payload.notification?.icon || "icon.png";
        // 커스텀 알림 표시 (새로운 Notification 객체 생성)
        new Notification(title, {
          body: body,
          icon: icon,
          data: payload.data, // 필요한 경우 추가 데이터 포함
        });
      });
    </script>
  </body>
</html>
